<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario Hilos | Existencias</title>
    <link rel="stylesheet" href="CSS/style.css">
</head>
<body>
    <div id="app">
        <div class="container">
            <aside class="sidebar">
                <div class="user-info">
                    <img src="assets/imágenes/íconos/portrait.png" alt="Foto de usuario" class="user-icon">
                    <p>Hola, Yurany García</p>
                </div>

                <nav class="menu">
                    <a href="index.html" class="menu-btn"><span style="vertical-align:middle;margin-right:10px;"><svg width="20" height="20" fill="none" viewBox="0 0 24 24"><path fill="#222" d="M3 12l9-9 9 9-1.41 1.41L12 5.83l-7.59 7.58z"/></svg></span>Menú</a>
                    <div class="menu-group">
                        <button class="menu-btn"><span style="vertical-align:middle;margin-right:10px;"><svg width="20" height="20" fill="none" viewBox="0 0 24 24"><path fill="#222" d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z"/></svg></span>Gestión de productos<span class="icon">&#9662;</span></button>
                        <div class="submenu">
                            <a href="categorias.html" class="submenu-btn"><span style="vertical-align:middle;margin-right:8px;"><svg width="18" height="18" fill="none" viewBox="0 0 24 24"><path fill="#222" d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg></span>Categorías</a>
                            <a href="productos.html" class="submenu-btn"><span style="vertical-align:middle;margin-right:8px;"><svg width="18" height="18" fill="none" viewBox="0 0 24 24"><path fill="#222" d="M16 6V4a4 4 0 0 0-8 0v2H4v16h16V6h-4zm-6-2a2 2 0 0 1 4 0v2h-4V4zm8 16H6V8h12v12z"/></svg></span>Productos</a>
                        </div>
                    </div>
                    <div class="menu-group">
                        <button class="menu-btn active"><span style="vertical-align:middle;margin-right:10px;"><svg width="20" height="20" fill="none" viewBox="0 0 24 24"><path fill="#222" d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm1 17.93V20h-2v-.07A8.001 8.001 0 0 1 4.07 13H4v-2h.07A8.001 8.001 0 0 1 11 4.07V4h2v.07A8.001 8.001 0 0 1 19.93 11H20v2h-.07A8.001 8.001 0 0 1 13 19.93z"/></svg></span>Existencias<span class="icon">&#9662;</span></button>
                        <div class="submenu" style="max-height: 300px;">
                            <a href="existencias.html" class="submenu-btn active"><span style="vertical-align:middle;margin-right:8px;"><svg width="18" height="18" fill="none" viewBox="0 0 24 24"><path fill="#222" d="M12 7a5 5 0 1 0 0 10 5 5 0 0 0 0-10zm0-5C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/></svg></span>Existencias</a>
                        </div>
                    </div>
                </nav>

                <div class="footer">
                    <p>Sistema de Inventario v1.0</p>
                </div>
            </aside>

            <main class="main-content">
                <section class="content-section">
                    <div class="section-header">
                        <h1 style="display: flex; align-items: center; gap: 0.7rem;">
                            <img src="assets/imágenes/íconos/8666718_plus_circle_icon.png" alt="Icono Existencias" style="width: 2.2rem; height: 2.2rem; vertical-align: middle;"> Existencias de Productos
                        </h1>
                        <div class="actions">
                            <div class="search-box">
                                <input type="text" id="buscar-existencia" placeholder="Buscar producto...">
                                <button class="search-btn">Buscar</button>
                            </div>
                            <a href="nuevo_producto.html" class="btn-primary">
                                <span>+</span> Nuevo Producto
                            </a>
                        </div>
                    </div>

                    <!-- ALERTA DE INVENTARIO BAJO -->
                    <div id="alerta-inventario-bajo" style="display:none; margin-bottom:1.2rem; background:linear-gradient(90deg,#fbbf24 60%,#fde68a 100%); color:#b45309; font-weight:600; border-radius:8px; box-shadow:0 2px 8px #fbbf2433; padding:1rem 1.2rem; text-align:center; font-size:1.08rem;">
                      <span style="font-size:1.3rem;vertical-align:middle;">⚠️</span> ¡Atención! Hay productos con inventario bajo. Revisa y repón existencias.
                    </div>

                    <div class="table-container" style="background: linear-gradient(90deg, #f1f5f9 60%, #e0e7ff 100%); border-radius: 12px; box-shadow: 0 2px 10px rgba(99,102,241,0.08); padding: 1rem 0.5rem;">
                        <table class="data-table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: linear-gradient(90deg, #6366f1 60%, #a5b4fc 100%); color: #fff;">
                                    <th style="border-radius: 8px 0 0 8px;">ID</th>
                                    <th>Nombre del Producto</th>
                                    <th>Categoría</th>
                                    <th style="border-radius: 0 8px 8px 0;">Stock Actual</th>
                                </tr>
                            </thead>
                            <tbody id="existencias-list">
                                <!-- Las filas se insertan dinámicamente -->
                            </tbody>
                        </table>
                        <div id="mensaje-existencias" style="margin-top: 1.2rem; color: #6366f1; font-weight: 500; text-align: center; display: none;">Cargando existencias...</div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const existenciasList = document.getElementById('existencias-list');
            const mensajeExistencias = document.getElementById('mensaje-existencias');
            const alertaInventarioBajo = document.getElementById('alerta-inventario-bajo');
            const buscarInput = document.getElementById('buscar-existencia');
            const buscarBtn = document.querySelector('.search-btn');

            function mostrarMensaje(texto, mostrar = true) {
                mensajeExistencias.textContent = texto;
                mensajeExistencias.style.display = mostrar ? 'block' : 'none';
            }

            async function cargarExistencias(filtro = '') {
                mostrarMensaje('Cargando existencias...');
                try {
                    const response = await fetch('/.netlify/functions/obtener_productos');
                    const productos = await response.json();

                    existenciasList.innerHTML = '';
                    let encontrados = 0;
                    let hayInventarioBajo = false;
                    const UMBRAL_BAJO = 5;

                    for (const producto of productos) {
                        if (filtro && !producto.nombre.toLowerCase().includes(filtro.toLowerCase())) continue;
                        encontrados++;
                        const newRow = existenciasList.insertRow();
                        const idCell = newRow.insertCell(0);
                        const nombreCell = newRow.insertCell(1);
                        const categoriaCell = newRow.insertCell(2);
                        const stockCell = newRow.insertCell(3);

                        idCell.textContent = producto.id;
                        nombreCell.textContent = producto.nombre;

                        try {
                            const categoriaResponse = await fetch(`/.netlify/functions/obtener_categoria?id=${producto.categoria_id}`);
                            if (categoriaResponse.ok) {
                                const categoriaData = await categoriaResponse.json();
                                categoriaCell.textContent = categoriaData.nombre;
                            } else {
                                categoriaCell.textContent = 'Categoría no encontrada';
                            }
                        } catch (error) {
                            categoriaCell.textContent = 'Error al cargar categoría';
                        }

                        stockCell.textContent = producto.stock;
                        // ALERTA Y RESALTADO
                        if (producto.stock < UMBRAL_BAJO) {
                            hayInventarioBajo = true;
                            newRow.style.background = 'linear-gradient(90deg,#fef3c7 60%,#fde68a 100%)';
                            newRow.style.color = '#b45309';
                            stockCell.innerHTML = `<span style='font-weight:bold;color:#b91c1c;'>${producto.stock} ⚠️</span>`;
                        }
                    }
                    if (encontrados === 0) {
                        mostrarMensaje('No se encontraron existencias para ese filtro.');
                    } else {
                        mostrarMensaje('', false);
                    }
                    // Mostrar u ocultar alerta
                    alertaInventarioBajo.style.display = hayInventarioBajo ? 'block' : 'none';
                } catch (error) {
                    mostrarMensaje('Error al cargar las existencias.');
                    alertaInventarioBajo.style.display = 'none';
                }
            }

            buscarBtn.addEventListener('click', () => {
                cargarExistencias(buscarInput.value);
            });
            buscarInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') cargarExistencias(buscarInput.value);
            });

            cargarExistencias();
        });
    </script>
</body>
</html>